<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>WebRTC Mesh å¤šäººè§†é¢‘ä¼šè®®</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: Arial, sans-serif;
        }
        
        body {
            background-color: #1e1e1e;
            color: #fff;
            padding: 20px;
        }
        
        .header {
            text-align: center;
            margin-bottom: 20px;
        }
        
        .title {
            font-size: 20px;
            font-weight: bold;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 10px;
            margin-bottom: 15px;
        }
        
        .camera-icon {
            font-size: 24px;
        }
        
        .server-url {
            display: flex;
            justify-content: center;
            margin-bottom: 15px;
        }
        
        .url-input {
            padding: 8px 12px;
            width: 300px;
            border-radius: 4px 0 0 4px;
            border: none;
        }
        
        .connect-btn {
            padding: 8px 15px;
            background-color: #09f;
            color: white;
            border: none;
            border-radius: 0 4px 4px 0;
            cursor: pointer;
        }
        
        /* ä¿®å¤ï¼šä¼˜åŒ–çŠ¶æ€æç¤ºæ¡†æ ·å¼ï¼Œç¡®ä¿æ–‡å­—å¯è§ */
        .status-bar {
            padding: 12px 15px;
            border-radius: 6px;
            text-align: center;
            margin-bottom: 15px;
            transition: all 0.3s ease;
            background-color: #2ecc71; /* é»˜è®¤æˆåŠŸè‰² */
            color: #ffffff; /* å¼ºåˆ¶ç™½è‰²æ–‡å­— */
            font-weight: 500;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            position: relative;
        }
        
        /* é”™è¯¯çŠ¶æ€ - è°ƒæ•´èƒŒæ™¯è‰²ä¸ºæ·±çº¢è‰²ï¼Œä¿è¯æ–‡å­—å¯¹æ¯”åº¦ */
        .status-bar.error {
            background-color: #c0392b !important; 
            color: #ffffff !important; /* å¼ºåˆ¶ç™½è‰²æ–‡å­— */
        }
        
        /* ä¿¡æ¯çŠ¶æ€ - å¤©è“è‰²èƒŒæ™¯ */
        .status-bar.info {
            background-color: #3498db;
            color: #ffffff;
        }
        
        /* å…³é—­æŒ‰é’® */
        .status-bar .close-btn {
            position: absolute;
            top: 50%;
            right: 15px;
            transform: translateY(-50%);
            width: 16px;
            height: 16px;
            cursor: pointer;
            opacity: 0.8;
        }
        
        .status-bar .close-btn:hover {
            opacity: 1;
        }
        
        .controls {
            display: flex;
            justify-content: center;
            gap: 10px;
            margin-bottom: 20px;
        }
        
        .control-btn {
            padding: 8px 15px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-weight: bold;
            transition: opacity 0.3s ease;
        }
        
        .control-btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }
        
        .start-btn {
            background-color: #2ecc71;
            color: white;
        }
        
        .join-btn {
            background-color: #f39c12;
            color: white;
        }
        
        .leave-btn {
            background-color: #e74c3c;
            color: white;
        }
        
        .participants-panel {
            margin-bottom: 20px;
        }
        
        .panel-header {
            padding: 10px 15px;
            background-color: #2c3e50;
            border-radius: 4px 4px 0 0;
            font-weight: bold;
            margin-bottom: 10px;
        }
        
        .participant-list {
            max-height: 120px;
            overflow-y: auto;
            padding: 0 15px;
            background-color: #2c3e50;
            border-radius: 0 0 4px 4px;
        }
        
        .participant-item {
            padding: 6px 0;
            border-bottom: 1px solid #34495e;
        }
        
        .current-participant {
            background-color: #27ae60;
            padding: 6px 10px;
            border-radius: 4px;
            margin: 5px 0;
        }
        
        .video-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
            grid-gap: 15px;
            margin-bottom: 20px;
        }
        
        .video-container {
            position: relative;
            background-color: #2c3e50;
            border-radius: 8px;
            overflow: hidden;
            aspect-ratio: 16/9;
            height: 0;
            padding-bottom: 56.25%;
        }
        
        .video-container video {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            object-fit: cover;
        }
        
        .no-video {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            display: flex;
            align-items: center;
            justify-content: center;
            background-color: #2c3e50;
            color: #aaa;
        }
        
        .video-label {
            position: absolute;
            bottom: 10px;
            left: 10px;
            background-color: rgba(0, 0, 0, 0.5);
            color: white;
            padding: 2px 8px;
            border-radius: 4px;
            font-size: 12px;
        }
        
        .connection-info {
            background-color: #2c3e50;
            padding: 15px;
            border-radius: 4px;
        }
        
        .info-item {
            margin-bottom: 8px;
        }
        
        .info-label {
            font-weight: bold;
            margin-right: 8px;
        }
        
        .local-tag { background-color: #27ae60; }
        .participant-tag-1 { background-color: #3498db; }
        .participant-tag-2 { background-color: #9b59b6; }
        .participant-tag-3 { background-color: #e67e22; }
        
        .error {
            color: #e74c3c;
        }
    </style>
</head>
<body>
    <div class="header">
        <div class="title">ğŸ¥ WebRTC Mesh å¤šäººè§†é¢‘ä¼šè®®</div>
    </div>
    
    <div class="server-url">
        <input type="text" id="serverUrl" class="url-input" value="http://localhost:8081">
        <button id="connectBtn" class="connect-btn">è¿æ¥</button>
    </div>
    
    <!-- ä¿®å¤ï¼šæ·»åŠ å…³é—­æŒ‰é’®ï¼Œä¼˜åŒ–æ ·å¼ -->
    <div class="status-bar" id="statusBar">
        æœªè¿æ¥
        <span class="close-btn" id="statusCloseBtn" onclick="this.parentElement.textContent=''; this.parentElement.className='status-bar'">âœ•</span>
    </div>
    
    <div class="controls">
        <button id="startCameraBtn" class="control-btn start-btn" disabled>å¼€å¯æ‘„åƒå¤´</button>
        <button id="joinMeetingBtn" class="control-btn join-btn" disabled>åŠ å…¥ä¼šè®®</button>
        <button id="leaveMeetingBtn" class="control-btn leave-btn" disabled>ç¦»å¼€ä¼šè®®</button>
    </div>
    
    <div class="participants-panel">
        <div class="panel-header">å‚ä¼šäººå‘˜ (<span id="participantCount">0</span>/4)</div>
        <div class="participant-list" id="participantList"></div>
    </div>
    
    <div class="video-grid" id="videoGrid"></div>
    
    <div class="connection-info">
        <div class="info-item"><span class="info-label">æˆ‘çš„ID:</span> <span id="myId">æœªè¿æ¥</span></div>
        <div class="info-item"><span class="info-label">ä¼šè®®çŠ¶æ€:</span> <span id="meetingStatus">æœªåŠ å…¥</span></div>
        <div class="info-item"><span class="info-label">è¿æ¥çŠ¶æ€:</span> <span id="connectionStatus">æœªè¿æ¥</span></div>
    </div>

    <script>
        // DOMå…ƒç´ 
        const connectBtn = document.getElementById('connectBtn');
        const serverUrlInput = document.getElementById('serverUrl');
        const statusBar = document.getElementById('statusBar');
        const startCameraBtn = document.getElementById('startCameraBtn');
        const joinMeetingBtn = document.getElementById('joinMeetingBtn');
        const leaveMeetingBtn = document.getElementById('leaveMeetingBtn');
        const videoGrid = document.getElementById('videoGrid');
        const participantCount = document.getElementById('participantCount');
        const participantList = document.getElementById('participantList');
        const myIdElement = document.getElementById('myId');
        const meetingStatusElement = document.getElementById('meetingStatus');
        const connectionStatusElement = document.getElementById('connectionStatus');

        // æ ¸å¿ƒçŠ¶æ€
        let ws = null;
        let myStream = null;
        let peers = {}; // { å¯¹æ–¹ID: { pc: RTCPeerConnection, tracksAdded: false } }
        let myId = null;
        let isCameraOn = false;
        let isJoined = false;
        let participants = new Set(); // å‚ä¼šè€…IDé›†åˆï¼ˆå®Œå…¨è·ŸéšæœåŠ¡å™¨æ•°æ®ï¼‰
        let isFirstConnect = true; // æ ‡è®°æ˜¯å¦é¦–æ¬¡è¿æ¥

        // åˆå§‹åŒ–
        connectBtn.addEventListener('click', connectToServer);
        startCameraBtn.addEventListener('click', toggleCamera);
        joinMeetingBtn.addEventListener('click', joinMeeting);
        leaveMeetingBtn.addEventListener('click', leaveMeeting);

        // è½¬æ¢HTTPåœ°å€åˆ°WSåœ°å€
        function toWsUrl(httpUrl) {
            return httpUrl.replace('http://', 'ws://').replace('https://', 'wss://');
        }

        // è¿æ¥ä¿¡ä»¤æœåŠ¡å™¨ - ä¿®å¤é¦–æ¬¡è¿æ¥é”™è¯¯é—®é¢˜
        function connectToServer() {
            // é˜²æ­¢é‡å¤ç‚¹å‡»
            if (connectBtn.disabled) return;
            connectBtn.disabled = true;
            
            if (ws) {
                ws.close();
                ws = null;
            }
            
            const url = toWsUrl(serverUrlInput.value.trim());
            updateStatus(`æ­£åœ¨è¿æ¥ ${url}...`, 'info');
            
            // ä¿®å¤ï¼šå¢åŠ è¿æ¥è¶…æ—¶å¤„ç†
            const connectTimeout = setTimeout(() => {
                updateStatus('âŒ è¿æ¥æœåŠ¡å™¨è¶…æ—¶ï¼Œè¯·æ£€æŸ¥åœ°å€æˆ–æœåŠ¡å™¨çŠ¶æ€', 'error');
                connectBtn.disabled = false;
                isFirstConnect = false;
            }, 10000); // 10ç§’è¶…æ—¶
            
            ws = new WebSocket(url);
            
            // è¿æ¥æˆåŠŸ
            ws.onopen = () => {
                clearTimeout(connectTimeout); // æ¸…é™¤è¶…æ—¶å®šæ—¶å™¨
                updateStatus('âœ… å·²è¿æ¥åˆ°ä¿¡ä»¤æœåŠ¡å™¨', 'success');
                connectionStatusElement.textContent = 'å·²è¿æ¥';
                startCameraBtn.disabled = false;
                joinMeetingBtn.disabled = false;
                connectBtn.disabled = false;
                isFirstConnect = false;
            };

            // æ¥æ”¶æ¶ˆæ¯
            ws.onmessage = (e) => {
                try {
                    const msg = JSON.parse(e.data);
                    handleServerMsg(msg);
                } catch (err) {
                    console.error('è§£ææ¶ˆæ¯å¤±è´¥:', err);
                    // éé¦–æ¬¡è¿æ¥æ‰æ˜¾ç¤ºè§£æé”™è¯¯ï¼Œé¿å…é¦–æ¬¡è¿æ¥å¹²æ‰°
                    if (!isFirstConnect) {
                        updateStatus(`âŒ æ¶ˆæ¯è§£æé”™è¯¯: ${err.message}`, 'error');
                    }
                }
            };

            // è¿æ¥å…³é—­
            ws.onclose = (event) => {
                clearTimeout(connectTimeout);
                // ä¿®å¤ï¼šåŒºåˆ†ä¸»åŠ¨å…³é—­å’Œå¼‚å¸¸å…³é—­
                if (event.wasClean) {
                    updateStatus('â„¹ï¸ ä¸æœåŠ¡å™¨æ­£å¸¸æ–­å¼€è¿æ¥', 'info');
                } else {
                    // éé¦–æ¬¡è¿æ¥æ‰æ˜¾ç¤ºé”™è¯¯ï¼Œé¿å…é¦–æ¬¡è¿æ¥è¯¯æŠ¥
                    if (!isFirstConnect) {
                        updateStatus('âŒ ä¸æœåŠ¡å™¨å¼‚å¸¸æ–­å¼€è¿æ¥', 'error');
                    } else {
                        updateStatus('âŒ è¿æ¥æœåŠ¡å™¨å¤±è´¥ï¼Œè¯·æ£€æŸ¥åœ°å€æ˜¯å¦æ­£ç¡®', 'error');
                    }
                }
                connectionStatusElement.textContent = 'å·²æ–­å¼€';
                connectBtn.disabled = false;
                resetState();
                isFirstConnect = false;
            };

            // è¿æ¥é”™è¯¯
            ws.onerror = (err) => {
                clearTimeout(connectTimeout);
                console.error('WSé”™è¯¯:', err);
                // éé¦–æ¬¡è¿æ¥æ‰æ˜¾ç¤ºè¯¦ç»†é”™è¯¯
                if (!isFirstConnect) {
                    updateStatus(`âŒ è¿æ¥é”™è¯¯: ${err.message || 'æœªçŸ¥é”™è¯¯'}`, 'error');
                } else {
                    updateStatus('âŒ è¿æ¥æœåŠ¡å™¨å¤±è´¥ï¼Œè¯·ç¡®ä¿æœåŠ¡å™¨å·²å¯åŠ¨', 'error');
                }
                connectBtn.disabled = false;
                isFirstConnect = false;
            };
        }

        // å¤„ç†æœåŠ¡å™¨æ¶ˆæ¯
        function handleServerMsg(msg) {
            switch (msg.type) {
                // æ”¶åˆ°è‡ªå·±çš„ID
                case 'client-id':
                    myId = msg.id;
                    myIdElement.textContent = myId;
                    updateParticipantsUI();
                    break;
                
                // æ”¶åˆ°å…¨é‡å‚ä¼šè€…åˆ—è¡¨ï¼ˆæ ¸å¿ƒï¼šå®Œå…¨æ›¿æ¢æœ¬åœ°é›†åˆï¼‰
                case 'participants-list':
                    participants = new Set(msg.participants);
                    updateParticipantsUI();
                    // å¦‚æœå·²åŠ å…¥ä¼šè®®ï¼Œå»ºç«‹P2Pè¿æ¥
                    if (isJoined && isCameraOn) {
                        createAllPeerConnections();
                    }
                    break;
                
                // æ–°ç”¨æˆ·åŠ å…¥
                case 'user-joined':
                    participants.add(msg.id);
                    updateParticipantsUI();
                    if (isJoined && isCameraOn && msg.id !== myId) {
                        // ä¿®å¤ï¼šå…ˆåˆ›å»ºè¿æ¥ï¼Œå»¶è¿Ÿå‘é€Offerç¡®ä¿å¯¹æ–¹å‡†å¤‡å¥½
                        createPeerConnection(msg.id);
                        setTimeout(() => sendOffer(msg.id), 500);
                    }
                    break;
                
                // ç”¨æˆ·ç¦»å¼€
                case 'user-left':
                    participants.delete(msg.id);
                    updateParticipantsUI();
                    removePeer(msg.id);
                    removeVideoElement(msg.id);
                    break;
                
                // æ”¶åˆ°Offer
                case 'offer':
                    handleOffer(msg.from, msg.offer);
                    break;
                
                // æ”¶åˆ°Answer
                case 'answer':
                    handleAnswer(msg.from, msg.answer);
                    break;
                
                // æ”¶åˆ°ICEå€™é€‰
                case 'ice-candidate':
                    handleIceCandidate(msg.from, msg.candidate);
                    break;
                
                // é”™è¯¯æ¶ˆæ¯
                case 'error':
                    // ä¿®å¤ï¼šæœåŠ¡å™¨é”™è¯¯åªåœ¨éé¦–æ¬¡è¿æ¥æ—¶æ˜¾ç¤º
                    if (!isFirstConnect) {
                        updateStatus(`âŒ ${msg.message}`, 'error');
                    }
                    break;
            }
        }

        // å‘é€æ¶ˆæ¯åˆ°æœåŠ¡å™¨
        function sendToServer(data) {
            if (ws && ws.readyState === WebSocket.OPEN) {
                ws.send(JSON.stringify(data));
            } else if (!isFirstConnect) { // éé¦–æ¬¡è¿æ¥æ‰æç¤ºå‘é€å¤±è´¥
                updateStatus('âŒ æ— æ³•å‘é€æ¶ˆæ¯ï¼šæœªè¿æ¥åˆ°æœåŠ¡å™¨', 'error');
            }
        }

        // å¼€å¯/å…³é—­æ‘„åƒå¤´
        async function toggleCamera() {
            if (isCameraOn) {
                // å…³é—­æ‘„åƒå¤´
                myStream.getTracks().forEach(track => track.stop());
                myStream = null;
                isCameraOn = false;
                startCameraBtn.textContent = 'å¼€å¯æ‘„åƒå¤´';
                updateStatus('ğŸ“¹ æ‘„åƒå¤´å·²å…³é—­', 'info');
                clearVideos();
            } else {
                // å¼€å¯æ‘„åƒå¤´
                try {
                    myStream = await navigator.mediaDevices.getUserMedia({
                        video: true,
                        audio: true
                    });
                    isCameraOn = true;
                    startCameraBtn.textContent = 'å…³é—­æ‘„åƒå¤´';
                    updateStatus('ğŸ“¹ æ‘„åƒå¤´å·²å¼€å¯', 'success');
                    // æ·»åŠ æœ¬åœ°è§†é¢‘
                    addLocalVideo();
                } catch (err) {
                    updateStatus(`âŒ å¼€å¯æ‘„åƒå¤´å¤±è´¥: ${err.message}`, 'error');
                    console.error(err);
                }
            }
        }

        // åŠ å…¥ä¼šè®®
        function joinMeeting() {
            if (!isCameraOn) {
                updateStatus('è¯·å…ˆå¼€å¯æ‘„åƒå¤´', 'error');
                return;
            }
            
            isJoined = true;
            joinMeetingBtn.disabled = true;
            leaveMeetingBtn.disabled = false;
            meetingStatusElement.textContent = 'å·²åŠ å…¥';
            updateStatus('ğŸ¤ æ­£åœ¨å»ºç«‹P2Pè¿æ¥...', 'info');
            
            // ä¸»åŠ¨å‘é€åŠ å…¥ä¼šè®®æŒ‡ä»¤
            sendToServer({ type: 'join-meeting' });
            // è¯·æ±‚å…¨é‡å‚ä¼šè€…åˆ—è¡¨
            sendToServer({ type: 'get-participants' });
            // å»ºç«‹æ‰€æœ‰P2Pè¿æ¥
            createAllPeerConnections();
        }

        // ç¦»å¼€ä¼šè®®
        function leaveMeeting() {
            isJoined = false;
            joinMeetingBtn.disabled = false;
            leaveMeetingBtn.disabled = true;
            meetingStatusElement.textContent = 'æœªåŠ å…¥';
            
            // å…³é—­æ‰€æœ‰P2Pè¿æ¥
            Object.keys(peers).forEach(id => removePeer(id));
            // é€šçŸ¥æœåŠ¡å™¨
            sendToServer({ type: 'leave-meeting' });
            
            updateStatus('ğŸ‘‹ å·²ç¦»å¼€ä¼šè®®', 'info');
        }

        // åˆ›å»ºæ‰€æœ‰P2Pè¿æ¥
        function createAllPeerConnections() {
            participants.forEach(id => {
                if (id !== myId && !peers[id]) {
                    createPeerConnection(id);
                    // ä¿®å¤ï¼šå»¶è¿Ÿå‘é€Offerï¼Œé¿å…è¿æ¥æœªåˆå§‹åŒ–å®Œæˆ
                    setTimeout(() => sendOffer(id), 500);
                }
            });
        }

        // åˆ›å»ºå•ä¸ªP2Pè¿æ¥
        function createPeerConnection(peerId) {
            // å¢å¼ºICEæœåŠ¡å™¨é…ç½®ï¼Œå¢åŠ å¤‡ç”¨STUNæœåŠ¡å™¨
            const pc = new RTCPeerConnection({
                iceServers: [
                    { urls: 'stun:stun.l.google.com:19302' },
                    { urls: 'stun:stun1.l.google.com:19302' },
                    { urls: 'stun:stun2.l.google.com:19302' }
                ]
            });
            
            // å­˜å‚¨PeerConnection
            peers[peerId] = { pc, tracksAdded: false };

            // ç›‘å¬ICEå€™é€‰
            pc.onicecandidate = (e) => {
                if (e.candidate) {
                    sendToServer({
                        type: 'ice-candidate',
                        target: peerId,
                        candidate: e.candidate
                    });
                }
            };

            // ä¿®å¤ï¼šå¢å¼ºontrackç›‘å¬ï¼Œç¡®ä¿èƒ½æ•è·åˆ°è¿œç¨‹æµ
            pc.ontrack = (e) => {
                console.log(`æ”¶åˆ° ${peerId} çš„åª’ä½“è½¨é“:`, e.track.kind);
                // ç¡®ä¿streamæœ‰è½¨é“
                if (e.streams && e.streams[0] && e.streams[0].getTracks().length > 0) {
                    addRemoteVideo(peerId, e.streams[0]);
                } else {
                    // å¤‡ç”¨æ–¹æ¡ˆï¼šæ‰‹åŠ¨åˆ›å»ºstreamå¹¶æ·»åŠ è½¨é“
                    let stream = document.getElementById(`peer-${peerId}`)?.querySelector('video')?.srcObject;
                    if (!stream) {
                        stream = new MediaStream();
                        addRemoteVideo(peerId, stream);
                    }
                    stream.addTrack(e.track);
                }
            };

            // ç›‘å¬è¿œç¨‹æµæ·»åŠ ï¼ˆå…¼å®¹éƒ¨åˆ†æµè§ˆå™¨ï¼‰
            pc.onaddstream = (e) => {
                console.log(`æ”¶åˆ° ${peerId} çš„åª’ä½“æµï¼ˆå…¼å®¹æ¨¡å¼ï¼‰`);
                addRemoteVideo(peerId, e.stream);
            };

            // ç›‘å¬è¿æ¥çŠ¶æ€
            pc.onconnectionstatechange = () => {
                console.log(`P2PçŠ¶æ€ [${peerId}]:`, pc.connectionState);
                if (pc.connectionState === 'connected') {
                    updateStatus(`âœ… ä¸ ${peerId} å»ºç«‹P2Pè¿æ¥`, 'success');
                } else if (pc.connectionState === 'failed') {
                    // ä¿®å¤ï¼šP2Pè¿æ¥å¤±è´¥ä¸æ˜¾ç¤ºå…¨çº¢é”™è¯¯ï¼Œæ”¹ç”¨infoçŠ¶æ€
                    updateStatus(`â„¹ï¸ ä¸ ${peerId} è¿æ¥å¤±è´¥ï¼Œæ­£åœ¨é‡è¯•...`, 'info');
                    // è¿æ¥å¤±è´¥æ—¶è‡ªåŠ¨é‡è¯•
                    setTimeout(() => {
                        removePeer(peerId);
                        createPeerConnection(peerId);
                        sendOffer(peerId);
                    }, 2000);
                }
            };

            // ä¿®å¤ï¼šç¡®ä¿æœ¬åœ°è½¨é“æ­£ç¡®æ·»åŠ 
            if (myStream && !peers[peerId].tracksAdded) {
                myStream.getTracks().forEach(track => {
                    try {
                        const sender = pc.addTrack(track, myStream);
                        console.log(`æ·»åŠ æœ¬åœ°${track.kind}è½¨é“åˆ° ${peerId}`, sender);
                    } catch (err) {
                        console.warn(`æ·»åŠ è½¨é“åˆ° ${peerId} å¤±è´¥:`, err);
                    }
                });
                peers[peerId].tracksAdded = true;
            }

            return pc;
        }

        // å‘é€Offer
        function sendOffer(peerId) {
            const pc = peers[peerId]?.pc;
            if (!pc || pc.signalingState === 'closed') return;

            pc.createOffer({
                offerToReceiveVideo: true,
                offerToReceiveAudio: true
            }).then(offer => {
                return pc.setLocalDescription(offer).then(() => offer);
            }).then(offer => {
                sendToServer({
                    type: 'offer',
                    target: peerId,
                    offer: offer
                });
                console.log(`å‘é€Offeråˆ° ${peerId}`, offer);
            }).catch(err => {
                // ä¿®å¤ï¼šOfferå¤±è´¥åªåœ¨æ§åˆ¶å°æ‰“å°ï¼Œä¸æ˜¾ç¤ºå…¨çº¢é”™è¯¯
                console.error(`å‘ ${peerId} å‘é€Offerå¤±è´¥:`, err);
                // åªæ˜¾ç¤ºä¿¡æ¯æç¤ºï¼Œä¸æ˜¾ç¤ºé”™è¯¯
                updateStatus(`â„¹ï¸ ä¸ ${peerId} åå•†ä¸­ï¼Œè¯·ç¨å€™...`, 'info');
                // Offeråˆ›å»ºå¤±è´¥æ—¶é‡è¯•
                setTimeout(() => sendOffer(peerId), 1000);
            });
        }

        // å¤„ç†æ”¶åˆ°çš„Offer
        function handleOffer(peerId, offer) {
            console.log(`æ”¶åˆ° ${peerId} çš„Offer`, offer);
            // åˆ›å»ºP2Pè¿æ¥ï¼ˆå¦‚æœä¸å­˜åœ¨ï¼‰
            if (!peers[peerId]) createPeerConnection(peerId);
            
            const pc = peers[peerId].pc;
            if (pc.signalingState === 'closed') return;
            
            pc.setRemoteDescription(new RTCSessionDescription(offer))
                .then(() => pc.createAnswer())
                .then(answer => {
                    return pc.setLocalDescription(answer).then(() => answer);
                })
                .then(answer => {
                    sendToServer({
                        type: 'answer',
                        target: peerId,
                        answer: answer
                    });
                    console.log(`å‘é€Answeråˆ° ${peerId}`, answer);
                })
                .catch(err => {
                    console.error('å¤„ç†Offerå¤±è´¥:', err);
                    // ä¿®å¤ï¼šåªæ˜¾ç¤ºä¿¡æ¯æç¤ºï¼Œä¸æ˜¾ç¤ºé”™è¯¯
                    updateStatus(`â„¹ï¸ å¤„ç† ${peerId} çš„è¿æ¥è¯·æ±‚ä¸­...`, 'info');
                });
        }

        // å¤„ç†æ”¶åˆ°çš„Answer
        function handleAnswer(peerId, answer) {
            console.log(`æ”¶åˆ° ${peerId} çš„Answer`, answer);
            const pc = peers[peerId]?.pc;
            if (!pc || pc.signalingState === 'closed') return;
            
            pc.setRemoteDescription(new RTCSessionDescription(answer))
                .catch(err => {
                    console.error('å¤„ç†Answerå¤±è´¥:', err);
                    updateStatus(`â„¹ï¸ ä¸ ${peerId} è¿æ¥åå•†ä¸­...`, 'info');
                });
        }

        // å¤„ç†ICEå€™é€‰
        function handleIceCandidate(peerId, candidate) {
            const pc = peers[peerId]?.pc;
            if (!pc || pc.signalingState === 'closed') return;
            
            pc.addIceCandidate(new RTCIceCandidate(candidate))
                .catch(err => {
                    console.warn(`æ·»åŠ ICEå€™é€‰åˆ° ${peerId} å¤±è´¥:`, err);
                });
        }

        // ç§»é™¤P2Pè¿æ¥
        function removePeer(peerId) {
            if (peers[peerId]) {
                try {
                    peers[peerId].pc.close();
                } catch (err) {
                    console.warn(`å…³é—­ ${peerId} è¿æ¥å¤±è´¥:`, err);
                }
                delete peers[peerId];
            }
        }

        // === UIç›¸å…³å‡½æ•° ===
        // æ›´æ–°çŠ¶æ€æç¤º - æ ¸å¿ƒä¿®å¤ï¼šä¼˜åŒ–æ ·å¼å’Œæ˜¾ç¤ºé€»è¾‘
        function updateStatus(text, type = 'success') {
            statusBar.textContent = text;
            statusBar.className = 'status-bar';
            
            // ç¡®ä¿å…³é—­æŒ‰é’®å§‹ç»ˆæ˜¾ç¤º
            const closeBtn = document.createElement('span');
            closeBtn.className = 'close-btn';
            closeBtn.innerHTML = 'âœ•';
            closeBtn.onclick = () => {
                statusBar.textContent = '';
                statusBar.className = 'status-bar';
            };
            
            // æ¸…é™¤ç°æœ‰å…³é—­æŒ‰é’®ï¼Œæ·»åŠ æ–°çš„
            const existingCloseBtn = statusBar.querySelector('.close-btn');
            if (existingCloseBtn) existingCloseBtn.remove();
            statusBar.appendChild(closeBtn);
            
            // è®¾ç½®æ ·å¼ï¼šç¡®ä¿æ–‡å­—å¯è§
            if (type === 'error') {
                statusBar.classList.add('error');
                statusBar.style.color = '#ffffff'; // å¼ºåˆ¶ç™½è‰²æ–‡å­—
                statusBar.style.fontWeight = '600'; // åŠ ç²—æ–‡å­—
            } else if (type === 'info') {
                statusBar.classList.add('info');
            }
            // successçŠ¶æ€ä½¿ç”¨é»˜è®¤æ ·å¼
        }

        // æ›´æ–°å‚ä¼šè€…UI
        function updateParticipantsUI() {
            participantCount.textContent = participants.size;
            participantList.innerHTML = '';
            
            participants.forEach(id => {
                const item = document.createElement('div');
                item.className = id === myId ? 'participant-item current-participant' : 'participant-item';
                item.textContent = id === myId ? `æˆ‘ (${id})` : `å‚ä¸è€… (${id})`;
                participantList.appendChild(item);
            });
        }

        // æ·»åŠ æœ¬åœ°è§†é¢‘
        function addLocalVideo() {
            clearVideos(); // å…ˆæ¸…ç©º
            const container = createVideoContainer('local', 'æˆ‘ (æœ¬åœ°)');
            const video = container.querySelector('video');
            video.srcObject = myStream;
            video.muted = true; // é™éŸ³æœ¬åœ°
            // ä¿®å¤ï¼šç¡®ä¿è§†é¢‘èƒ½è‡ªåŠ¨æ’­æ”¾
            video.play().catch(err => {
                console.warn('æœ¬åœ°è§†é¢‘æ’­æ”¾å¤±è´¥:', err);
                // å°è¯•ç”¨æˆ·äº¤äº’è§¦å‘æ’­æ”¾ï¼ˆå¤‡ç”¨æ–¹æ¡ˆï¼‰
                video.addEventListener('click', () => video.play(), { once: true });
            });
            videoGrid.appendChild(container);
        }

        // æ·»åŠ è¿œç¨‹è§†é¢‘
        function addRemoteVideo(peerId, stream) {
            // ç§»é™¤æ—§çš„è§†é¢‘å…ƒç´ 
            removeVideoElement(peerId);
            
            const container = createVideoContainer(`peer-${peerId}`, `å‚ä¸è€… (${peerId})`);
            const video = container.querySelector('video');
            video.srcObject = stream;
            // ä¿®å¤ï¼šç¡®ä¿è¿œç¨‹è§†é¢‘èƒ½è‡ªåŠ¨æ’­æ”¾
            video.autoplay = true;
            video.playsInline = true;
            video.muted = false;
            // å¼ºåˆ¶è§¦å‘æ’­æ”¾
            video.play().catch(err => {
                console.warn(`${peerId} è§†é¢‘æ’­æ”¾å¤±è´¥:`, err);
                // æ˜¾ç¤ºæ— è§†é¢‘æç¤º
                const noVideo = document.createElement('div');
                noVideo.className = 'no-video';
                noVideo.textContent = 'ç­‰å¾…è§†é¢‘æµ...';
                container.appendChild(noVideo);
                // ç›‘å¬è½¨é“æ·»åŠ äº‹ä»¶
                stream.addEventListener('addtrack', () => {
                    noVideo.remove();
                    video.play();
                });
            });
            videoGrid.appendChild(container);
        }

        // åˆ›å»ºè§†é¢‘å®¹å™¨
        function createVideoContainer(id, labelText) {
            const container = document.createElement('div');
            container.className = 'video-container';
            container.id = id;
            
            const video = document.createElement('video');
            video.autoplay = true;
            video.playsInline = true;
            video.width = 300;
            video.height = 200;
            
            const label = document.createElement('div');
            label.className = 'video-label';
            label.textContent = labelText;
            
            container.appendChild(video);
            container.appendChild(label);
            return container;
        }

        // ç§»é™¤è§†é¢‘å…ƒç´ 
        function removeVideoElement(peerId) {
            const el = document.getElementById(`peer-${peerId}`);
            if (el) el.remove();
        }

        // æ¸…ç©ºæ‰€æœ‰è§†é¢‘
        function clearVideos() {
            videoGrid.innerHTML = '';
        }

        // é‡ç½®æ‰€æœ‰çŠ¶æ€
        function resetState() {
            isCameraOn = false;
            isJoined = false;
            participants.clear(); // æ¸…ç©ºå‚ä¼šè€…é›†åˆ
            Object.keys(peers).forEach(id => removePeer(id));
            clearVideos();
            
            startCameraBtn.disabled = true;
            joinMeetingBtn.disabled = true;
            leaveMeetingBtn.disabled = true;
            
            myIdElement.textContent = 'æœªè¿æ¥';
            meetingStatusElement.textContent = 'æœªåŠ å…¥';
            participantCount.textContent = '0';
            participantList.innerHTML = '';
            
            // é‡ç½®é¦–æ¬¡è¿æ¥æ ‡è®°
            isFirstConnect = true;
        }

        // ä¿®å¤ï¼šé¡µé¢åŠ è½½å®Œæˆåè¯·æ±‚ç”¨æˆ·äº¤äº’æƒé™
        document.addEventListener('DOMContentLoaded', () => {
            // ç›‘å¬ç”¨æˆ·ç‚¹å‡»ï¼Œè§£é”è‡ªåŠ¨æ’­æ”¾
            document.body.addEventListener('click', () => {
                document.querySelectorAll('video').forEach(video => {
                    if (video.paused && video.srcObject) {
                        video.play().catch(err => console.warn('æ’­æ”¾å¤±è´¥:', err));
                    }
                });
            }, { once: true });
        });
    </script>
</body>
</html>